name: Docker Compose Build Check

on:
  push:
    branches: [ "main", "master" ]
  pull_request:
    branches: [ "main", "master" ]

jobs:
  fast-build-check:
    runs-on: ubuntu-latest
    environment: integration # Required reviewers
    
    env:
      POSTGRES_USER: user
      POSTGRES_PASSWORD: password
      POSTGRES_DB: lumix_db
      MEILI_MASTER_KEY: dummy_key
      MINIO_ACCESS_KEY: minioadmin
      MINIO_SECRET_KEY: minioadmin123
      ADMIN_PASSWORD: dummy_admin
      ADMIN_USERNAME: admin
      CORS_ALLOWED_ORIGINS: "*"
      
    steps:
      - uses: actions/checkout@v4

      - name: Set up Docker Buildx and Cache
        uses: docker/setup-buildx-action@v3

      - name: Build and Start All Services
        run: |
          docker compose -f docker-compose.yml up -d --build --force-recreate

      - name: Wait for initial startup (30s)
        run: sleep 30

      - name: Check Service Health Status
        run: |
          docker compose ps
          if docker compose ps --filter "status=exited" | grep -q "Exited"; then
            echo "ERROR: One or more services failed to start!"
            docker compose logs
            exit 1
          fi

      - name: Cleanup Containers
        if: always() 
        run: docker compose -f docker-compose.yml down -v --rmi all
